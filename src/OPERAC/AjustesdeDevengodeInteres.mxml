<?xml version="1.0" encoding="utf-8"?>
<mx:Canvas xmlns:mx="http://www.adobe.com/2006/mxml" creationComplete="initApp()" width="100%" xmlns:forms="forms.*" 
	xmlns:Data="Data.*" horizontalScrollPolicy="off" creationPolicy="all" xmlns:Administracion="Administracion.*" 
	height="100%">
	
	<!--Componente de Registro de Ajustes-->
	<mx:Script>
		<![CDATA[
			import Data.Globales;
			import Data.Utils;
			import mx.collections.ArrayCollection;
			import mx.containers.TitleWindow;
			import mx.controls.Alert;
			import mx.core.Application;
			import mx.effects.easing.Elastic;
			import mx.events.CloseEvent;	
			import mx.events.DataGridEvent;				
			import mx.events.FlexEvent;
			import mx.events.ListEvent;	
			import mx.events.ValidationResultEvent;
			import mx.managers.PopUpManager;
			import mx.rpc.events.FaultEvent;
			import mx.rpc.events.ResultEvent;
			import mx.rpc.Fault;
			import mx.rpc.soap.WebService;
			import mx.rpc.xml.SimpleXMLDecoder;
			import mx.utils.ArrayUtil;  
			          
			public var _xmlInfo:XML = new XML();
			
			private var wsMS:WebService;	
			private var titulo:String;
			private var codigo:String;
			private var tipoCred:String;
			private var ciclo:String;
			private var saldoInt:Number;
			private var du:Utils;
			private var global:Globales;
			private var vResult:ValidationResultEvent;
		
			public function buscarInfo():void{
				var wsCat:WebService = new WebService;
				var params:Array = new Array;
				if (txtCodigo.text != "" && txtCiclo.text != ""){
					codigo = txtCodigo.text;
					ciclo = txtCiclo.text;
					btnBuscar.setFocus();
					
					du.initWsCat(wsCat);
					du.sCursor();
					global.bloquear();
							
					du.ejecutaWsMethod(wsCat,function(evt:ResultEvent):void {																				
						_xmlInfo = new XML(evt.result);
						
						du.rCursor();
						du.closeWs(wsCat);
						global.desbloquear();
				
						if (_xmlInfo.elements().length() > 0){
							saldoInt = Number(_xmlInfo.Table[0].INTERES);
							lblSdoInteres.text = global.formatearMoneda(saldoInt.toString());
							calculaNuevoSaldo();
						}		
						else
							du.mostrarMensaje("No se ha encontrado informaci칩n.\n\nVerifique los datos capturados.",titulo,4,null,null,global.iAlert);
					});
					params[0] = codigo;
					params[1] = tipoCred;
					params[2] = ciclo;
					wsCat.getInfoGeneral.send(10, params);
				}	
				else
					du.mostrarMensaje("Debe capturar el c칩digo y ciclo.",titulo,4,null,null,global.iAlert);
			}
			
			public function calculaNuevoSaldo():void{
				var nvoInt:Number;
				nvoInt = saldoInt + Number((txtInteres.text == "" ? "0": global.formatearNumerico(txtInteres.text)));
				lblNvoSdoInt.text = global.formatearMoneda(nvoInt.toString());
			}
			
			public function enviar():void{
				if(valida()){
					var interes:Number;
					var fecha:String;
					
					interes = Number((txtInteres.text == "" ? "0": txtInteres.text));
					fecha = dtfFecha.text;
					
					initConexion();
					du.sCursor();
							
					du.ejecutaWsMethod(wsMS,function(evt:ResultEvent):void {																				
						var res:String = evt.result.toString();
						
						du.rCursor();
						du.closeWs(wsMS);
							
						if(res.substr(0,1) == "1"){	
							du.mostrarMensaje("Proceso finalizado exitosamente.",titulo,4,null,null,global.iInfo);
							limpiar();
						}
						else
							du.mostrarMensaje(res.substr(2,res.length-1),titulo,4,null,null,global.iAlert);
					}); 
					wsMS.setRegAjusteDevengo.send(codigo, ciclo, tipoCred, fecha, interes, global.obtenerUsuario());
				}
			}
			
			private function formatearMonto(event:Event):void{
				global.formatearMonto(event);
				calculaNuevoSaldo();
			}
			
			public function initApp():void{
				global = new Globales();
				du = new Utils();
				titulo = "Registro de Ajustes de Devengo";
				tipoCred = "I";
				lblTitulo.text = titulo.toUpperCase();
				limpiar();
			}
			
			public function initConexion():void{				
				wsMS = new WebService();			
				wsMS.wsdl = Application.application.wsStr.wsdlServ.toString();
				wsMS.loadWSDL();
			}			
			
			private function limpiar():void{
				var fec:Date = global.obtenerFechaSistema();
				dtfFecha.selectedDate = global.seleccionarDiaHabil(new Date(fec.fullYear,fec.month,fec.date));
				saldoInt = 0;
				txtCodigo.text = "";
				txtCiclo.text = "";
				lblSdoInteres.text = "";
				lblNvoSdoInt.text = "";
				txtInteres.text = "";
			}
			
			public function valida():Boolean{
				if(dtfFecha.text == ""){
					du.mostrarMensaje("Debe capturar la fecha del ajuste.",titulo,4,null,null,global.iAlert);
					return false;
				}
				if((txtInteres.text == "" || txtInteres.text == "-" || Number(txtInteres.text) == 0)){
					du.mostrarMensaje("Debe capturar una cantidad v치lida.",titulo,4,null,null,global.iAlert);
					return false;
				}
				return true;
			}

		]]>
	</mx:Script>
	<mx:Canvas backgroundAlpha="1.0" backgroundColor="#FFFFFF" width="490" height="270">
		<mx:Canvas id="cnvDetalle" x="10" y="92" width="470" height="130" styleName="canvasMod" visible="true" enabled="true">
			<mx:Label id="lblFecha" x="59.75" y="54" text="Fecha:" width="50" textAlign="right"/>
			<mx:Label id="lblInteres" x="259.25" y="53" text="Interes:" textAlign="right"/>
			<mx:Label id="lblSdoInteres" x="228.5" y="10" width="90"/>
			<mx:Label id="lblESdoInteres" x="149.5" y="10" text="Saldo Interes:" textAlign="right"/>
			<mx:HRule x="10" y="42" width="448"/>
			<mx:Label id="lblNvoSdoInt" x="228.5" y="97" width="100"/>
			<mx:Label id="lblENvoSdoInt" x="115.5" y="97" text="Nuevo Saldo Interes:" textAlign="right"/>
			<mx:HRule x="10" y="87" width="448"/>
			<mx:DateField id="dtfFecha" x="117.75" y="53" width="100"/>
			<mx:TextInput id="txtInteres" x="308.25" y="52" width="100" maxChars="9" restrict="0-9;.;,;\-" focusOut="formatearMonto(event)"/>
		</mx:Canvas>
		<mx:Label id="lblTitulo" x="10" y="10" width="380.5" fontSize="12" fontWeight="bold" fontStyle="italic"/>
		<mx:Canvas id="cnvEncabezado" x="28" y="39" width="434" height="45" styleName="canvasMod">
			<mx:Label id="lblCodigo" x="51.7" y="12" text="C칩digo:" width="50" textAlign="right"/>
			<mx:Label id="lblCiclo" x="185.7" y="12" text="Ciclo:" width="45" textAlign="right"/>
			<mx:TextInput id="txtCodigo" x="109.7" y="10" width="68" enter="buscarInfo()" maxChars="6" restrict="0-9"/>
			<mx:TextInput id="txtCiclo" x="238.7" y="10" width="50" enter="buscarInfo()" maxChars="2" restrict="0-9"/>
			<mx:Button id="btnBuscar" x="318.25" y="10" icon="@Embed(source='assets/ico_lupa.png')" click="buscarInfo()" toolTip="Buscar Grupo"/>
		</mx:Canvas>
		<mx:Button id="btnAceptar" x="400" y="230" icon="@Embed(source='assets/button_ok.png')" click="enviar()" enabled="true" toolTip="Aceptar" width="80"/>
	</mx:Canvas>
</mx:Canvas>