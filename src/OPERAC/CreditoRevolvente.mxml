<?xml version="1.0" encoding="utf-8"?>
<mx:Canvas xmlns:mx="http://www.adobe.com/2006/mxml" creationComplete="initApp()" width="100%" xmlns:forms="forms.*" 
	xmlns:Data="Data.*" horizontalScrollPolicy="off" creationPolicy="all" xmlns:Administracion="Administracion.*" height="100%">
	
	<!--Componente de mantenimiento de credito revolvente-->
	<mx:Script>
		<![CDATA[
			import Data.Permisos;
			import Data.Utils;
			import mx.controls.DataGrid;
			import mx.controls.dataGridClasses.DataGridItemRenderer;  
			import mx.events.*;  
			import Data.Globales;
			import mx.controls.ComboBox;
			import mx.events.FlexEvent;
			import mx.formatters.SwitchSymbolFormatter;
			import mx.formatters.NumberFormatter;
			import mx.rpc.Fault;
			import mx.rpc.soap.WebService;
			import mx.rpc.events.ResultEvent;
			import mx.rpc.events.FaultEvent;
			import mx.events.DataGridEvent;				
			import mx.events.CloseEvent;	
			import mx.events.ListEvent;	
			import mx.core.Application;
			import mx.containers.TitleWindow;				
			import mx.managers.PopUpManager;
			import mx.controls.Alert;
			import mx.collections.ArrayCollection;
			import mx.effects.easing.Elastic;
			import mx.events.ValidationResultEvent;            

			[Bindable]
			public var dPermisos:XML = new XML();
			public var _xmlCR:XML = new XML();
			public var _xmlAcred:XML = new XML();
			
			public var objMtto:Sprite = new Sprite();
			
			private var du:Utils;
			private var global:Globales;
			private var permiso:Permisos;
			public var wsMS:WebService;	
			public var titulo:String;
			
			//variables que especifican el indice del elemento 
			//seleccionado al realizar la modificacion del registro
			public var accionCredRev:int;
			public var indCredRev:int;
			public var vScroll:Number;
			public var res:String;
			
			//variables que indican las opciones disponibles para el usuario
			public var alta:Boolean = new Boolean();
			public var borrado:Boolean = new Boolean();
			public var consulta:Boolean = new Boolean();
			public var edicion:Boolean = new Boolean();
			
			public function activarContGarantia(band:Boolean):void{
				btnDatosAcred.enabled = band;	
			}	
					
			public function activarContCredRev(band:Boolean):void{
				if(alta == true)
					btnAgregarCR.enabled = band;
				btnDatosCR.enabled = band;
			}
			
			public function activarContModCredRev(band:Boolean):void{
				if(borrado == true)
					btnEliminarCR.enabled = band;
				if(edicion == true)	
					btnEditarCR.enabled = band;
			}
			
			public function actualizarCredRev(event:Event):void{
				buscarListaCredRev(1);
			}
			
			public function buscarAcred():void{
				var wsCat:WebService = new WebService;
				var params:Array = new Array;
				
				if (txtCodAcred.text != "" || txtPaterno.text != "" || txtNombre.text != ""){
					btnBuscar.setFocus();
					dgAcred.dataProvider = null;
					
					du.initWsCat(wsCat);
					du.sCursor();
					global.bloquear();
					
					du.ejecutaWsMethod(wsCat,function(evt:ResultEvent):void {											
						_xmlAcred = new XML(evt.result);
						
						du.rCursor();
						du.closeWs(wsCat);	
						global.desbloquear();
						
						if (_xmlAcred.elements().length() > 0){
							dgAcred.dataProvider = _xmlAcred.Table;
						}
						seleccionaAcred();
					});
					params[0] = global.obtenerUsuario();
					params[1] = txtCodAcred.text;
					params[2] = txtNombre.text;
					params[3] = txtPaterno.text;
					//Informacion de Acreditados sin grupo asignado
					wsCat.getInfoAcred.send(9, params);
				}	
			}
			
			public function buscarListaCredRev(tipo:int):void{
				var wsCat:WebService = new WebService;
				var params:Array = new Array;
				var acred:String = dgAcred.selectedItem.CODIGO;
				
				du.initWsCat(wsCat);
				du.sCursor();
			 	if(tipo == 1)
			 		global.bloquear();
			 		
			 	du.ejecutaWsMethod(wsCat,function(evt:ResultEvent):void {											
					_xmlCR = new XML(evt.result);
					
					du.rCursor();
					du.closeWs(wsCat);	
					global.desbloquear();
					
					dgCredRev.dataProvider = null;
					if (_xmlCR.elements().length() > 0){
						dgCredRev.dataProvider = _xmlCR.Table;
						if (accionCredRev == 2){
							dgCredRev.validateNow();
							dgCredRev.verticalScrollPosition = vScroll;
							dgCredRev.selectedIndex = indCredRev;
							this.accionCredRev = 0;
						}
						activarContGarantia(true);
					}
					else
						activarContGarantia(false);
					seleccionaCredRev();
				});
				params[0] = acred;
				//Informacion de Acreditados sin grupo asignado
				wsCat.getInfoAcred.send(15, params);
			}
			
			public function eliminarCredRev():void{
				var indSolic:int = dgCredRev.selectedIndex;
				Alert.show("¿Desea eliminar el Crédito seleccionado?",titulo, Alert.YES|Alert.NO,null, manejadorEliminarCredRev,global.iQuest);
			}
			
			public function iniVar():void{
				this.indCredRev = -1;
				this.vScroll = -1;
			}
			
			public function initApp():void{
				du = new Utils();
				global = new Globales();
				permiso = new Permisos();
				titulo = "Crédito Revolvente";
				alta = true;
				borrado = true;
				consulta = true;
				edicion = true;
				//permisos();
			}
			
			public function initConexion():void{				
				wsMS = new WebService();			
				wsMS.wsdl = Application.application.wsStr.wsdlServ.toString();
				wsMS.loadWSDL();
			}			
			
			public function manejadorEliminarCredRev(e:CloseEvent):void{
				if(e.detail==Alert.YES){    	
					var acred:String = dgAcred.selectedItem.CODIGO;
					var autorizado:String = dgCredRev.selectedItem.FAUTORIZADO; 
					initConexion();
					du.sCursor();
					global.bloquear();
					wsMS.addEventListener(ResultEvent.RESULT, setAccionCredRevolvente);
					wsMS.setAccionCredRevolvente.send(3, acred, autorizado, "", "", 0, "", "");
			    } 
			}
			
			public function mostrarFormCredRev(tipo:int):void{
				//tipo = 1 NUEVO REGISTRO
				//tipo = 2 MODIFICA REGISTRO
				var acred:String;
				var nomAcred:String;
				var autorizo:String;
				var nomAutorizo:String;
				var autorizado:String;
				var indAcred:int;
				
				if(edicion == true){
					var comMttoCredRev:MttoCredRevolvente = new MttoCredRevolvente();
					acred = dgAcred.selectedItem.CODIGO;
					nomAcred = dgAcred.selectedItem.NOMBRE_CL;
					autorizo = global.obtenerUsuario();
					nomAutorizo = Application.application.NOM_U_ID;
					switch(tipo){
						case 1: 
							//ASIGNACION QUE ESTABLECE AL OBJETO PADRE
							objMtto = this;	
							comMttoCredRev = MttoCredRevolvente(PopUpManager.createPopUp(objMtto,MttoCredRevolvente,true));
							comMttoCredRev.addEventListener(Event.REMOVED_FROM_STAGE, actualizarCredRev);
							PopUpManager.centerPopUp(comMttoCredRev);
							comMttoCredRev.init(tipo, acred, nomAcred, autorizo, nomAutorizo);					
							break;
						case 2: 
							if (dgCredRev.selectedIndex >= 0){
								accionCredRev = tipo;					
								comMttoCredRev = MttoCredRevolvente(PopUpManager.createPopUp(this,MttoCredRevolvente,true));  
								comMttoCredRev.addEventListener(Event.REMOVED_FROM_STAGE, actualizarCredRev);
								PopUpManager.centerPopUp(comMttoCredRev);
								iniVar();
								this.vScroll = dgCredRev.verticalScrollPosition;		
								this.indCredRev = dgCredRev.selectedIndex;
								//Obtiene la fecha de autorizacion del prestamo
								autorizado = dgCredRev.selectedItem.FAUTORIZADO;
								comMttoCredRev.init(tipo, acred, nomAcred, autorizo, nomAutorizo, autorizado);
							}
							else
								Alert.show("Debe seleccionar el registro del Crédito Revolvente",titulo,4,null,null,global.iAlert); 
							break;
					}
				}
			}
			
			public function permisos():void{
				var mod_id:String = Application.application._Current_Mod_Id;
				var perfil_id:String = Application.application.cadPerfil;
				var Params:Array;
				var cont:int;
				
				initConexion();
				du.sCursor();
					
				du.ejecutaWsMethod(wsMS,function(evt:ResultEvent):void {											
					dPermisos = new XML(evt.result.toString());
						
					du.rCursor();
					du.closeWs(wsMS);
						
					cont = dPermisos.elements().length();
					
					for(var i:int = 0; i < cont; i++){
						switch(dPermisos.Table[i].OPCION.toString()){
							case "C":
								consulta = true;
								if (permiso.permisosModSolic(Application.application.PERFIL_ID)){
									borrado = true;
									alta = true;
									edicion = true;
								}
								break;	
							/*case "B":
								borrado = true;
								break;
							case "I":
								alta = true;
								break;
							case "E":
								edicion = true;
								break;*/
						}
					}			
				});
				Params = new Array();
				Params[0] = perfil_id;
				Params[1] = mod_id;
				wsMS.ESLoginMethods.send(14,Params);	//Método que indica las opciones disponibles para el usuario	
			}		
			
			public function seleccionaAcred():void{
				dgCredRev.dataProvider = null;
				dgGarantia.dataProvider = null;
				activarContGarantia(false);
				if (dgAcred.selectedIndex >= 0){
					activarContCredRev(true);
				}
				else{
					activarContCredRev(false);
				}
			}
			
			public function seleccionaCredRev():void{
				dgGarantia.dataProvider = null;
				activarContGarantia(false);
				if (dgCredRev.selectedIndex >= 0){
					activarContModCredRev(true);
					activarContGarantia(true);
				}
				else{
					activarContModCredRev(false);
				}
			}
			
			private function setAccionCredRevolvente(event:ResultEvent):void{
				wsMS.disconnect();
				du.rCursor();
				global.desbloquear();
				wsMS.removeEventListener(ResultEvent.RESULT, setAccionCredRevolvente);
				var res:String = new String(event.result.toString());
				if (res.substr(0,1) == "1")
					buscarListaCredRev(1);
				else
					Alert.show(res.substr(2,res.length-1),titulo,4,null,null,global.iAlert);
			}
			
		]]>
	</mx:Script>
	<mx:Canvas width="800" height="450" backgroundColor="#FFFFFF" backgroundAlpha="1.0" verticalScrollPolicy="off">
		<mx:Canvas id="cnvDetalle" x="18.5" y="84" width="763.5" height="146" cornerRadius="10" borderStyle="solid" borderColor="#7B8B93" visible="true">
			<Data:RowColorDataGrid id="dgAcred" x="10" y="10" width="741.5" height="124" sortableColumns="true" resizableColumns="false" 
				verticalScrollPolicy="on" horizontalScrollPolicy="on" itemClick="seleccionaAcred()" doubleClickEnabled="true" itemDoubleClick="buscarListaCredRev(1)"> 
				<Data:columns>
					<mx:DataGridColumn headerText="CODIGO" dataField="CODIGO" width="70"/>
					<mx:DataGridColumn headerText="ACREDITADO" dataField="NOMBRE_CL" width="250"/>
					<mx:DataGridColumn headerText="SUCURSAL" dataField="COORD" width="80"/>
					<mx:DataGridColumn headerText="NOMBRE SUCURSAL" dataField="NOMCO" width="170"/>
					<mx:DataGridColumn headerText="CODIGO" dataField="CDGPRPE" width="70"/>
					<mx:DataGridColumn headerText="OFICIAL DE CREDITO" dataField="PROMOTOR" width="200"/>
					<mx:DataGridColumn headerText="MUNICIPIO" dataField="MUNIC" width="150"/>
					<mx:DataGridColumn headerText="LOCALIDAD" dataField="LOCALIDAD" width="200"/>
					<mx:DataGridColumn headerText="COLONIA" dataField="COLONIA" width="200"/>
				</Data:columns>
			</Data:RowColorDataGrid>
		</mx:Canvas>
		<mx:Label x="18" y="10" text="ACREDITADO" width="247" fontSize="12" fontWeight="bold" fontStyle="italic"/>
		<mx:Canvas x="721" y="39" width="61" height="37" cornerRadius="10" borderStyle="solid" borderColor="#7B8B93" visible="true">
			<mx:Button id="btnBuscar" x="10" y="3" icon="@Embed(source='assets/ico_lupa.png')" click="buscarAcred()" toolTip="Buscar Acreditado" width="40"/>
		</mx:Canvas>
		<mx:Canvas id="cnvCredito" x="18.5" y="289" width="763.5" height="146" cornerRadius="10" borderStyle="solid" borderColor="#7B8B93" visible="true" verticalScrollPolicy="off">
			<Data:RowColorDataGrid id="dgCredRev" x="10" y="10" width="741.5" height="124" sortableColumns="false" resizableColumns="false" 
				verticalScrollPolicy="auto" itemClick="seleccionaCredRev()" doubleClickEnabled="true" itemDoubleClick="mostrarFormCredRev(2)" 
				horizontalScrollPolicy="auto"> 
				<Data:columns>
					<mx:DataGridColumn headerText="AUTORIZADO" dataField="FAUTORIZADO" width="120"/>
					<mx:DataGridColumn headerText="MONTO" dataField="MONTO" width="120"/>
					<mx:DataGridColumn headerText="INICIO" dataField="FINICIO" width="120"/>
					<mx:DataGridColumn headerText="FIN" dataField="FFIN" width="120"/>
					<mx:DataGridColumn headerText="FIN CREDITO REVOLVENTE" dataField="FFINPRC" width="140"/>
				</Data:columns>
			</Data:RowColorDataGrid>
		</mx:Canvas>
		<mx:Canvas x="528" y="244" width="203" height="37" cornerRadius="10" borderStyle="solid" borderColor="#7B8B93" visible="true" id="canvas1">
			<mx:Button id="btnAgregarCR" x="103" y="3" icon="@Embed(source='assets/add.png')" enabled="false" click="mostrarFormCredRev(1)" toolTip="Agregar Crédito Revolvente" width="40"/>
			<mx:Button id="btnEliminarCR" x="151" y="3" icon="@Embed(source='assets/delete-icon.png')" enabled="false" click="eliminarCredRev()" toolTip="Eliminar Crédito Revolvente" width="40"/>
			<mx:Button id="btnEditarCR" x="58" y="3" icon="@Embed(source='assets/edit.png')" enabled="false" click="mostrarFormCredRev(2)" toolTip="Editar Crédito Revolvente" width="40"/>
			<mx:Button id="btnDatosCR" x="10" y="3" icon="@Embed(source='assets/folder.png')" click="buscarListaCredRev(1)" enabled="false" toolTip="Créditos Revolventes" width="40"/>
		</mx:Canvas>
		<mx:Label x="18.5" y="260" text="CRÉDITO REVOLVENTE" width="247" fontSize="12" fontWeight="bold" fontStyle="italic"/>
		<mx:Label x="18.5" y="465" text="GARANTÍA" width="247" fontSize="12" fontWeight="bold" fontStyle="italic" visible="false"/>
		<mx:Canvas x="722" y="449" width="60" height="37" cornerRadius="10" borderStyle="solid" borderColor="#7B8B93" visible="false">
			<mx:Button id="btnDatosAcred" x="9" y="3" icon="@Embed(source='assets/folder.png')" enabled="false" toolTip="Garantías del Acreditado" width="40"/>
		</mx:Canvas>
		<mx:Canvas id="cnvDetalle2" x="18.5" y="494" width="763.5" height="146" cornerRadius="10" borderStyle="solid" borderColor="#7B8B93" visible="false" verticalScrollPolicy="off">
			<Data:RowColorDataGrid id="dgGarantia" x="10" y="10" width="741.5" height="124"
				sortableColumns="false" draggableColumns="false" resizableColumns="false" 
				verticalScrollPolicy="on" itemClick="seleccionaAcred()"> 
				<Data:columns>
					<mx:DataGridColumn headerText="CODIGO" dataField="CDGCL" width="50"/>
					<mx:DataGridColumn headerText="ACREDITADO" dataField="NOMBRE_CL" width="180"/>
					<mx:DataGridColumn headerText="PROYECTO DE INVERSION" dataField="NOMBRE" width="120"/>
					<mx:DataGridColumn headerText="FECHA SOL." dataField="FECSOL" width="65"/>
					<mx:DataGridColumn headerText="MONTO SOL." dataField="CANTSOLIC" width="65"/>
					<mx:DataGridColumn headerText="MONTO AUTORIZADO" dataField="CANTAUTOR" width="100"/>
				</Data:columns>
			</Data:RowColorDataGrid>
		</mx:Canvas>
		<mx:Image x="739" y="238" width="43" height="43" source="assets/notepad.png"/>
	</mx:Canvas>
	<mx:Canvas x="18" y="39" width="695" height="37" cornerRadius="10" borderStyle="solid" borderColor="#7B8B93" visible="true">
		<mx:Label id="lblCodAcred" x="15" y="7" text="Código:" textAlign="right"/>
		<mx:TextInput id="txtCodAcred" x="64" y="6" width="68" enter="buscarAcred()" maxChars="6" restrict="0-9"/>
		<mx:Label id="lblPaterno" x="470" y="7" text="Apellido Paterno:" textAlign="right"/>
		<mx:TextInput id="txtPaterno" x="564" y="6" width="110" enter="buscarAcred()" maxChars="50"/>
		<mx:Label id="lblNombre" x="158" y="7" text="Nombre/Razón Social:" textAlign="right"/>
		<mx:TextInput id="txtNombre" x="277" y="6" width="170" enter="buscarAcred()" maxChars="50"/>
	</mx:Canvas>
</mx:Canvas>